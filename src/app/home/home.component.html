<div class="home-container">
  <!-- Date Navigation -->
  <div class="date-nav">
    <button class="nav-btn" (click)="prevDay()">‚Äπ</button>
    <div class="date-display">
      <span class="date-label">{{ getFormattedDate() }}</span>
      <span class="date-full">{{ selectedDate }}</span>
    </div>
    <button class="nav-btn" (click)="nextDay()" [disabled]="isToday()">‚Ä∫</button>
    <button *ngIf="!isToday()" class="today-btn" (click)="goToToday()">Today</button>
  </div>

  <!-- Main Two-Column Layout -->
  <div class="main-layout">
    <!-- Left: Action List -->
    <section class="actions-section">
      <app-action-list
        *ngIf="isToday()"
        [actions]="dailyActions"
        [isLoading]="isLoadingDashboard"
        [collapsed]="actionsCollapsed"
        [editMode]="actionsEditMode"
        (actionClick)="onActionClick($event)"
        (actionUncomplete)="onActionUncomplete($event)"
        (toggleCollapse)="onActionsToggleCollapse()"
        (reorder)="onActionsReorder($event)"
        (toggleEditMode)="onActionsToggleEditMode()">
      </app-action-list>
      
      <!-- Quick Actions for past dates -->
      <div class="quick-actions" *ngIf="!isToday()">
        <button *ngIf="!currentEntry" (click)="addEntryForDate()" class="action-btn primary">
          + Add Entry
        </button>
        <button *ngIf="currentEntry" (click)="editEntry()" class="action-btn secondary">
          ‚úé Edit Entry
        </button>
        <button *ngIf="whoopConnected && !currentEntry" (click)="importFromWhoop()" class="action-btn whoop" [disabled]="whoopLoading">
          {{ whoopLoading ? 'Importing...' : 'Import Whoop' }}
        </button>
      </div>
      
      <!-- Whoop Status -->
      <div class="whoop-status success" *ngIf="whoopConnected && whoopHasRefreshToken">
        <span class="status-icon">‚úì</span>
        <span class="status-text">Whoop connected</span>
      </div>
      <div class="whoop-status expired" *ngIf="whoopExpired && !whoopConnected">
        <span class="status-icon">‚ö†Ô∏è</span>
        <span class="status-text">Whoop expired</span>
        <button class="reconnect-btn" (click)="reconnectWhoop()">Reconnect</button>
      </div>
      <a *ngIf="!whoopConnected && !whoopExpired" routerLink="/integrations" class="connect-link">
        Connect Whoop ‚Üí
      </a>

      <!-- History -->
      <div class="history-section">
        <h4>üìÖ History</h4>
        <div *ngIf="isLoadingEntries" class="loading">Loading...</div>
        
        <div class="history-list" *ngIf="!isLoadingEntries && entries.length > 0">
          <div class="history-item" *ngFor="let entry of entries" 
               [class.selected]="entry.date === selectedDate"
               (click)="selectedDate = entry.date; loadDashboard()">
            <span class="history-date">{{ entry.date }}</span>
            <div class="history-stats">
              <span *ngIf="entry.recovery" class="mini-stat recovery">{{ entry.recovery }}%</span>
              <span *ngIf="entry.strain" class="mini-stat strain">{{ entry.strain }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoadingEntries && entries.length === 0" class="no-entries">
          No entries yet
        </div>
      </div>
    </section>

    <!-- Right: Dashboard -->
    <section class="dashboard-section">
      <app-dashboard
        [currentEntry]="currentEntry"
        [whoopWorkouts]="whoopWorkouts"
        [isLoading]="isLoadingDashboard"
        [selectedDate]="selectedDate"
        (editEntry)="editEntry()"
        (planWorkout)="openWorkoutPlanner()"
        (toggleWorkoutComplete)="toggleWorkoutCompleted()"
        (openWhoopWorkout)="openWhoopWorkoutEditor($event)"
        (mergeWorkout)="promptMergeWithPlanned($event)">
      </app-dashboard>
    </section>
  </div>

  <!-- Modals -->
  
  <!-- Entry Form Modal -->
  <div class="modal-overlay" *ngIf="showForm" (click)="toggleForm()"></div>
  <div class="modal" *ngIf="showForm">
    <div class="modal-header">
      <h3>{{ editingId ? 'Edit Entry' : 'New Entry' }}</h3>
      <button class="close-btn" (click)="toggleForm()">√ó</button>
    </div>
    
    <form [formGroup]="healthForm" (ngSubmit)="onSubmit()" class="health-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="date">Date</label>
          <input type="date" id="date" formControlName="date" required>
        </div>
        <div class="form-group">
          <label for="recovery">Recovery %</label>
          <input type="number" id="recovery" formControlName="recovery" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="sleep">Sleep %</label>
          <input type="number" id="sleep" formControlName="sleep" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="strain">Strain</label>
          <input type="number" id="strain" formControlName="strain" placeholder="0-21" step="0.1">
        </div>
        <div class="form-group">
          <label for="rhr">RHR (bpm)</label>
          <input type="number" id="rhr" formControlName="rhr" placeholder="bpm">
        </div>
        <div class="form-group">
          <label for="weight">Weight (lbs)</label>
          <input type="number" id="weight" formControlName="weight" placeholder="lbs" step="0.1">
        </div>
        <div class="form-group">
          <label for="bp">Blood Pressure</label>
          <input type="text" id="bp" formControlName="bp" placeholder="120/80">
        </div>
        <div class="form-group">
          <label for="dailyScore">Daily Score</label>
          <input type="number" id="dailyScore" formControlName="dailyScore" placeholder="-2 to 2" step="0.1">
        </div>
      </div>

      <div class="whoop-import" *ngIf="whoopConnected">
        <button type="button" (click)="fetchFromWhoop()" class="whoop-import-btn" [disabled]="whoopLoading">
          {{ whoopLoading ? 'Fetching...' : '‚Üì Import from Whoop' }}
        </button>
        <span class="whoop-msg" *ngIf="whoopMessage">{{ whoopMessage }}</span>
      </div>

      <div class="form-actions">
        <button type="button" (click)="toggleForm()" class="cancel-btn">Cancel</button>
        <button type="submit" [disabled]="!healthForm.valid || isLoading" class="submit-btn">
          {{ isLoading ? 'Saving...' : (editingId ? 'Update' : 'Save') }}
        </button>
      </div>
      
      <div class="save-message" *ngIf="saveMessage" [class.error]="saveMessage.includes('Error')">
        {{ saveMessage }}
      </div>
    </form>
  </div>

  <!-- Workout Planner Modal -->
  <div class="modal-overlay" *ngIf="showWorkoutPlanner" (click)="closeWorkoutPlanner()"></div>
  <div class="modal workout-modal" *ngIf="showWorkoutPlanner">
    <div class="modal-header">
      <h3>Plan Workout for {{ getFormattedDate() }}</h3>
      <button class="close-btn" (click)="closeWorkoutPlanner()">√ó</button>
    </div>
    
    <form [formGroup]="workoutForm" class="workout-form">
      <div class="form-row">
        <div class="form-group">
          <label>Workout Type</label>
          <select formControlName="type">
            <option value="Strength Training">Strength Training</option>
            <option value="Cardio">Cardio</option>
            <option value="HIIT">HIIT</option>
            <option value="Yoga">Yoga</option>
            <option value="Running">Running</option>
            <option value="Cycling">Cycling</option>
            <option value="Swimming">Swimming</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Duration (min)</label>
          <input type="number" formControlName="targetDuration" min="5" max="300">
        </div>
      </div>
      
      <button type="button" class="copy-last-btn" [disabled]="!hasLastWorkout()" (click)="copyLastWorkout()">
        üìã Copy Last Workout
      </button>
      
      <div class="exercise-builder">
        <h4>Exercises</h4>
        <div class="add-exercise">
          <input type="text" formControlName="exerciseName" placeholder="Exercise name">
          <input type="number" formControlName="exerciseSets" placeholder="Sets" class="small">
          <input type="text" formControlName="exerciseReps" placeholder="Reps" class="small">
          <input type="text" formControlName="exerciseWeight" placeholder="Weight">
          <button type="button" (click)="addExercise()">+ Add</button>
        </div>
        
        <div class="exercise-list" *ngIf="exercises.length > 0">
          <div class="exercise-item" *ngFor="let ex of exercises; let i = index">
            <span class="ex-name">{{ ex.name }}</span>
            <span class="ex-details">{{ ex.sets }} √ó {{ ex.reps }} <span *ngIf="ex.weight">&#64; {{ ex.weight }}</span></span>
            <button type="button" class="remove-btn" (click)="removeExercise(i)">√ó</button>
          </div>
        </div>
        
        <div class="no-exercises" *ngIf="exercises.length === 0">
          No exercises added
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" (click)="closeWorkoutPlanner()" class="cancel-btn">Cancel</button>
        <button type="button" (click)="saveWorkoutPlan()" class="submit-btn">Save Plan</button>
      </div>
    </form>
  </div>

  <!-- Whoop Workout Editor Modal -->
  <div class="modal-overlay" *ngIf="editingWhoopWorkout" (click)="closeWhoopWorkoutEditor()"></div>
  <div class="modal workout-modal" *ngIf="editingWhoopWorkout">
    <div class="modal-header">
      <h3>{{ editingWhoopWorkout.sport }} - {{ editingWhoopWorkout.startTime }}</h3>
      <button class="close-btn" (click)="closeWhoopWorkoutEditor()">√ó</button>
    </div>
    
    <div class="whoop-summary">
      <div class="summary-stat"><span>{{ editingWhoopWorkout.strain }}</span> Strain</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.duration }}m</span> Duration</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.calories }}</span> Calories</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.avgHR }}/{{ editingWhoopWorkout.maxHR }}</span> HR</div>
    </div>
    
    <form [formGroup]="workoutForm" class="workout-form">
      <div class="exercise-builder">
        <h4>Exercises Performed</h4>
        <div class="add-exercise">
          <input type="text" formControlName="exerciseName" placeholder="Exercise name">
          <input type="number" formControlName="exerciseSets" placeholder="Sets" class="small">
          <input type="text" formControlName="exerciseReps" placeholder="Reps" class="small">
          <input type="text" formControlName="exerciseWeight" placeholder="Weight">
          <button type="button" (click)="addExercise()">+ Add</button>
        </div>
        
        <div class="exercise-list" *ngIf="exercises.length > 0">
          <div class="exercise-item" *ngFor="let ex of exercises; let i = index">
            <span class="ex-name">{{ ex.name }}</span>
            <span class="ex-details">{{ ex.sets }} √ó {{ ex.reps }} <span *ngIf="ex.weight">&#64; {{ ex.weight }}</span></span>
            <button type="button" class="remove-btn" (click)="removeExercise(i)">√ó</button>
          </div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" (click)="closeWhoopWorkoutEditor()" class="cancel-btn">Cancel</button>
        <button type="button" (click)="saveWhoopWorkoutExercises()" class="submit-btn">Save</button>
      </div>
    </form>
  </div>

  <!-- Nutrition Panel Modal -->
  <div class="modal-overlay" *ngIf="showNutritionPanel" (click)="closeNutritionPanel()"></div>
  <div class="modal nutrition-modal" *ngIf="showNutritionPanel">
    <div class="modal-header">
      <h3>ü•ó Plan Nutrition</h3>
      <button class="close-btn" (click)="closeNutritionPanel()">√ó</button>
    </div>
    
    <div class="nutrition-options">
      <div class="nutrition-option" (click)="openMyFitnessPal()">
        <div class="option-icon">üì±</div>
        <div class="option-content">
          <h4>Open MyFitnessPal</h4>
          <p>Log meals manually in the MyFitnessPal app or website</p>
        </div>
        <span class="option-arrow">‚Üó</span>
      </div>
      
      <div class="nutrition-option" [class.disabled]="!mfpConnected" (click)="importFromMyFitnessPal()">
        <div class="option-icon">
          <span *ngIf="!mfpLoading">üîÑ</span>
          <span *ngIf="mfpLoading" class="spinner">‚è≥</span>
        </div>
        <div class="option-content">
          <h4>Import from MyFitnessPal</h4>
          <p *ngIf="!mfpConnected">Connect to automatically sync your meal data</p>
          <p *ngIf="mfpConnected">Download today's meals and create entries</p>
        </div>
        <span class="option-badge" *ngIf="!mfpConnected">Coming Soon</span>
        <span class="option-arrow" *ngIf="mfpConnected">‚Üí</span>
      </div>
    </div>
    
    <div class="nutrition-footer" *ngIf="!mfpConnected">
      <p class="coming-soon-note">
        üöß MyFitnessPal integration is coming soon. For now, use the manual option.
      </p>
    </div>
  </div>

  <!-- Merge Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMergePrompt" (click)="closeMergePrompt()"></div>
  <div class="modal small-modal" *ngIf="showMergePrompt && whoopToMerge">
    <div class="modal-header">
      <h3>Link to Planned Workout</h3>
      <button class="close-btn" (click)="closeMergePrompt()">√ó</button>
    </div>
    
    <div class="merge-content">
      <p>Merge <strong>{{ whoopToMerge.sport }}</strong> with your planned <strong>{{ getPlannedWorkout()?.type }}</strong>?</p>
      <p class="merge-note">This adds Whoop stats and marks workout complete.</p>
    </div>
    
    <div class="form-actions">
      <button type="button" (click)="closeMergePrompt()" class="cancel-btn">Cancel</button>
      <button type="button" (click)="mergeWhoopWithPlanned()" class="submit-btn">Merge</button>
    </div>
  </div>

  <!-- Chat FAB -->
  <button class="chat-fab" (click)="toggleChat()" [class.active]="showChat">
    <span *ngIf="!showChat">ü§ñ</span>
    <span *ngIf="showChat">‚úï</span>
  </button>

  <!-- Chat Panel -->
  <div class="chat-panel" *ngIf="showChat">
    <div class="chat-header">
      <h4>Jarvis AI</h4>
      <div class="chat-actions">
        <button class="analyze-btn" (click)="analyzeToday()" [disabled]="chatLoading">üìä Analyze</button>
        <button class="clear-btn" (click)="clearChat()">üóëÔ∏è</button>
      </div>
    </div>
    
    <div class="chat-messages">
      <div class="chat-welcome" *ngIf="chatMessages.length === 0">
        <p>üëã Ask me about your health data</p>
      </div>
      
      <div class="chat-message" *ngFor="let msg of chatMessages" 
           [class.user]="msg.role === 'user'"
           [class.assistant]="msg.role === 'assistant'">
        <div class="message-content">{{ msg.content }}</div>
      </div>
      
      <div class="chat-loading" *ngIf="chatLoading">Thinking...</div>
    </div>
    
    <div class="chat-input-area">
      <input type="text" [(ngModel)]="chatInput" placeholder="Ask something..." (keyup.enter)="sendChatMessage()" [disabled]="chatLoading">
      <button (click)="sendChatMessage()" [disabled]="chatLoading || !chatInput.trim()">‚û§</button>
    </div>
  </div>
</div>
