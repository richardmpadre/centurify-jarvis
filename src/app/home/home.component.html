<div class="home-container">
  <!-- Date Navigation -->
  <div class="date-nav">
    <button class="nav-btn" (click)="prevDay()">‚Äπ</button>
    <div class="date-display">
      <span class="date-label">{{ getFormattedDate() }}</span>
      <span class="date-full">{{ selectedDate }}</span>
    </div>
    <button class="nav-btn" (click)="nextDay()" [disabled]="isToday()">‚Ä∫</button>
    <button *ngIf="!isToday()" class="today-btn" (click)="goToToday()">Today</button>
  </div>

  <!-- Main Two-Column Layout -->
  <div class="main-layout">
    <!-- Left: Action List -->
    <section class="actions-section">
      <app-action-list
        *ngIf="isToday()"
        [actions]="dailyActions"
        [isLoading]="isLoadingDashboard"
        [collapsed]="actionsCollapsed"
        [editMode]="actionsEditMode"
        (actionClick)="onActionClick($event)"
        (actionUncomplete)="onActionUncomplete($event)"
        (toggleCollapse)="onActionsToggleCollapse()"
        (reorder)="onActionsReorder($event)"
        (toggleEditMode)="onActionsToggleEditMode()">
      </app-action-list>
      
      <!-- Quick Actions for past dates -->
      <div class="quick-actions" *ngIf="!isToday()">
        <button *ngIf="!currentEntry" (click)="addEntryForDate()" class="action-btn primary">
          + Add Entry
        </button>
        <button *ngIf="currentEntry" (click)="editEntry()" class="action-btn secondary">
          ‚úé Edit Entry
        </button>
        <button *ngIf="whoopConnected && !currentEntry" (click)="importFromWhoop()" class="action-btn whoop" [disabled]="whoopLoading">
          {{ whoopLoading ? 'Importing...' : 'Import Whoop' }}
        </button>
      </div>
      
      <!-- Whoop Status -->
      <div class="whoop-status success" *ngIf="whoopConnected && whoopHasRefreshToken">
        <span class="status-icon">‚úì</span>
        <span class="status-text">Whoop connected</span>
      </div>
      <div class="whoop-status expired" *ngIf="whoopExpired && !whoopConnected">
        <span class="status-icon">‚ö†Ô∏è</span>
        <span class="status-text">Whoop expired</span>
        <button class="reconnect-btn" (click)="reconnectWhoop()">Reconnect</button>
      </div>
      <a *ngIf="!whoopConnected && !whoopExpired" routerLink="/integrations" class="connect-link">
        Connect Whoop ‚Üí
      </a>

      <!-- History -->
      <div class="history-section">
        <h4>üìÖ History</h4>
        <div *ngIf="isLoadingEntries" class="loading">Loading...</div>
        
        <div class="history-list" *ngIf="!isLoadingEntries && entries.length > 0">
          <div class="history-item" *ngFor="let entry of entries" 
               [class.selected]="entry.date === selectedDate"
               (click)="selectedDate = entry.date; loadDashboard()">
            <span class="history-date">{{ entry.date }}</span>
            <div class="history-stats">
              <span *ngIf="entry.recovery" class="mini-stat recovery">{{ entry.recovery }}%</span>
              <span *ngIf="entry.strain" class="mini-stat strain">{{ entry.strain }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoadingEntries && entries.length === 0" class="no-entries">
          No entries yet
        </div>
      </div>
    </section>

    <!-- Right: Dashboard -->
    <section class="dashboard-section">
      <app-dashboard
        [currentEntry]="currentEntry"
        [whoopWorkouts]="whoopWorkouts"
        [mealEntries]="mealEntries"
        [isLoading]="isLoadingDashboard"
        [selectedDate]="selectedDate"
        (editEntry)="editEntry()"
        (planWorkout)="openWorkoutPlanner()"
        (toggleWorkoutComplete)="toggleWorkoutCompleted()"
        (openWhoopWorkout)="openWhoopWorkoutEditor($event)"
        (mergeWorkout)="promptMergeWithPlanned($event)"
        (openInsights)="openInsightsPanel()">
      </app-dashboard>
    </section>
  </div>

  <!-- Modals -->
  
  <!-- Entry Form Modal -->
  <div class="modal-overlay" *ngIf="showForm" (click)="toggleForm()"></div>
  <div class="modal" *ngIf="showForm">
    <div class="modal-header">
      <h3>{{ editingId ? 'Edit Entry' : 'New Entry' }}</h3>
      <button class="close-btn" (click)="toggleForm()">√ó</button>
    </div>
    
    <form [formGroup]="healthForm" (ngSubmit)="onSubmit()" class="health-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="date">Date</label>
          <input type="date" id="date" formControlName="date" required>
        </div>
        <div class="form-group">
          <label for="recovery">Recovery %</label>
          <input type="number" id="recovery" formControlName="recovery" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="sleep">Sleep %</label>
          <input type="number" id="sleep" formControlName="sleep" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="strain">Strain</label>
          <input type="number" id="strain" formControlName="strain" placeholder="0-21" step="0.1">
        </div>
        <div class="form-group">
          <label for="rhr">RHR (bpm)</label>
          <input type="number" id="rhr" formControlName="rhr" placeholder="bpm">
        </div>
        <div class="form-group">
          <label for="weight">Weight (lbs)</label>
          <input type="number" id="weight" formControlName="weight" placeholder="lbs" step="0.1">
        </div>
        <div class="form-group">
          <label for="bp">Blood Pressure</label>
          <input type="text" id="bp" formControlName="bp" placeholder="120/80">
        </div>
      </div>

      <div class="whoop-import" *ngIf="whoopConnected">
        <button type="button" (click)="fetchFromWhoop()" class="whoop-import-btn" [disabled]="whoopLoading">
          {{ whoopLoading ? 'Fetching...' : '‚Üì Import from Whoop' }}
        </button>
        <span class="whoop-msg" *ngIf="whoopMessage">{{ whoopMessage }}</span>
      </div>

      <div class="form-actions">
        <button type="button" (click)="toggleForm()" class="cancel-btn">Cancel</button>
        <button type="submit" [disabled]="!healthForm.valid || isLoading" class="submit-btn">
          {{ isLoading ? 'Saving...' : (editingId ? 'Update' : 'Save') }}
        </button>
      </div>
      
      <div class="save-message" *ngIf="saveMessage" [class.error]="saveMessage.includes('Error')">
        {{ saveMessage }}
      </div>
    </form>
  </div>

  <!-- Workout Planner -->
  <app-workout-planner
    [isOpen]="showWorkoutPlanner"
    [currentEntry]="currentEntry"
    [selectedDate]="selectedDate"
    [allEntries]="entries"
    (close)="closeWorkoutPlanner()"
    (workoutSaved)="onWorkoutSaved()">
  </app-workout-planner>

  <!-- Whoop Workout Editor Modal -->
  <div class="modal-overlay" *ngIf="editingWhoopWorkout" (click)="closeWhoopWorkoutEditor()"></div>
  <div class="modal workout-modal" *ngIf="editingWhoopWorkout">
    <div class="modal-header">
      <h3>{{ editingWhoopWorkout.sport }} - {{ editingWhoopWorkout.startTime }}</h3>
      <button class="close-btn" (click)="closeWhoopWorkoutEditor()">√ó</button>
    </div>
    
    <div class="whoop-summary">
      <div class="summary-stat"><span>{{ editingWhoopWorkout.strain }}</span> Strain</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.duration }}m</span> Duration</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.calories }}</span> Calories</div>
      <div class="summary-stat"><span>{{ editingWhoopWorkout.avgHR }}/{{ editingWhoopWorkout.maxHR }}</span> HR</div>
    </div>
    
    <div class="exercise-builder">
      <h4>Exercises Performed</h4>
      <div class="add-exercise">
        <input type="text" [(ngModel)]="exerciseName" placeholder="Exercise name">
        <input type="number" [(ngModel)]="exerciseSets" placeholder="Sets" class="small">
        <input type="text" [(ngModel)]="exerciseReps" placeholder="Reps" class="small">
        <input type="text" [(ngModel)]="exerciseWeight" placeholder="Weight">
        <button type="button" (click)="addExerciseToWhoop()">+ Add</button>
      </div>
      
      <div class="exercise-list" *ngIf="exercises.length > 0">
        <div class="exercise-item" *ngFor="let ex of exercises; let i = index">
          <span class="ex-name">{{ ex.name }}</span>
          <span class="ex-details">{{ ex.sets }} √ó {{ ex.reps }} <span *ngIf="ex.weight">&#64; {{ ex.weight }}</span></span>
          <button type="button" class="remove-btn" (click)="removeExerciseFromWhoop(i)">√ó</button>
        </div>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="button" (click)="closeWhoopWorkoutEditor()" class="cancel-btn">Cancel</button>
      <button type="button" (click)="saveWhoopWorkoutExercises()" class="submit-btn">Save</button>
    </div>
  </div>

  <!-- Nutrition Panel -->
  <app-nutrition-panel
    [isOpen]="showNutritionPanel"
    [selectedDate]="selectedDate"
    [mealEntries]="mealEntries"
    (close)="closeNutritionPanel()"
    (mealEntriesChanged)="onMealEntriesChanged($event)"
    (planSaved)="onNutritionPlanSaved()">
  </app-nutrition-panel>

  <!-- Meal Detail Panel -->
  <app-meal-detail-panel
    [isOpen]="showMealDetailPanel"
    [mealType]="mealDetailType"
    [selectedDate]="selectedDate"
    [mealEntries]="mealEntries"
    (close)="closeMealDetailPanel()"
    (mealEntriesChanged)="onMealEntriesChanged($event)"
    (mealTypeCompleted)="onMealTypeCompleted($event)">
  </app-meal-detail-panel>

  <!-- Training Panel -->
  <app-training-panel
    [isOpen]="showTrainingPanel"
    [currentEntry]="currentEntry"
    [whoopWorkouts]="whoopWorkouts"
    (close)="closeTrainingPanel()"
    (editPlan)="openWorkoutPlanner()"
    (markComplete)="markWorkoutCompleteAndClose()"
    (openWhoopWorkout)="openWhoopWorkoutEditor($event)"
    (mergeWorkout)="promptMergeWithPlanned($event)">
  </app-training-panel>

  <!-- Merge Confirmation Modal -->
  <div class="modal-overlay" *ngIf="showMergePrompt" (click)="closeMergePrompt()"></div>
  <div class="modal small-modal" *ngIf="showMergePrompt && whoopToMerge">
    <div class="modal-header">
      <h3>Link to Planned Workout</h3>
      <button class="close-btn" (click)="closeMergePrompt()">√ó</button>
    </div>
    
    <div class="merge-content">
      <p>Merge <strong>{{ whoopToMerge.sport }}</strong> with your planned <strong>{{ getPlannedWorkout()?.type }}</strong>?</p>
      <p class="merge-note">This adds Whoop stats and marks workout complete.</p>
    </div>
    
    <div class="form-actions">
      <button type="button" (click)="closeMergePrompt()" class="cancel-btn">Cancel</button>
      <button type="button" (click)="mergeWhoopWithPlanned()" class="submit-btn">Merge</button>
    </div>
  </div>

  <!-- Daily Insights Panel -->
  <app-insights-panel
    [isOpen]="showInsightsPanel"
    [currentEntry]="currentEntry"
    [selectedDate]="selectedDate"
    [mealEntries]="mealEntries"
    [whoopWorkouts]="whoopWorkouts"
    [dailyActions]="dailyActions"
    (close)="closeInsightsPanel()"
    (insightsSaved)="onInsightsSaved()">
  </app-insights-panel>

  <!-- Chat Panel -->
  <app-chat-panel
    [currentEntry]="currentEntry"
    [selectedDate]="selectedDate"
    [whoopWorkouts]="whoopWorkouts"
    [dailyActions]="dailyActions">
  </app-chat-panel>
</div>
