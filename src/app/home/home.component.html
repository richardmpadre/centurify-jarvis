<div class="dashboard-container">
  <!-- Date Navigation -->
  <div class="date-nav">
    <button class="nav-btn" (click)="prevDay()">‚Äπ</button>
    <div class="date-display">
      <span class="date-label">{{ getFormattedDate() }}</span>
      <span class="date-full">{{ selectedDate }}</span>
    </div>
    <button class="nav-btn" (click)="nextDay()" [disabled]="isToday()">‚Ä∫</button>
    <button *ngIf="!isToday()" class="today-btn" (click)="goToToday()">Today</button>
  </div>

  <!-- Morning Checklist -->
  <div class="morning-checklist" *ngIf="isToday() && !isLoadingDashboard">
    <div class="checklist-header">
      <h3>‚òÄÔ∏è Morning Routine</h3>
      <div class="progress-badge">{{ getChecklistProgress() }}%</div>
    </div>
    <div class="checklist-items">
      <div 
        class="checklist-item" 
        *ngFor="let item of morningChecklistItems"
        [class.completed]="isChecklistItemComplete(item.id)"
        (click)="handleChecklistItem(item.id)">
        <div class="check-circle">
          <span *ngIf="isChecklistItemComplete(item.id)">‚úì</span>
        </div>
        <div class="checklist-content">
          <span class="checklist-icon">{{ item.icon }}</span>
          <div class="checklist-text">
            <span class="checklist-title">{{ item.title }}</span>
            <span class="checklist-desc">{{ item.description }}</span>
          </div>
        </div>
        <span class="checklist-arrow">‚Üí</span>
      </div>
    </div>
  </div>

  <!-- Dashboard Stats -->
  <div class="stats-grid" *ngIf="!isLoadingDashboard">
    <!-- Recovery Card -->
    <div class="stat-card recovery-card" [class.has-data]="currentEntry?.recovery">
      <div class="stat-icon">üíö</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.recovery || '--' }}<span class="unit" *ngIf="currentEntry?.recovery">%</span></div>
        <div class="stat-label">Recovery</div>
      </div>
    </div>

    <!-- Sleep Card -->
    <div class="stat-card sleep-card" [class.has-data]="currentEntry?.sleep">
      <div class="stat-icon">üò¥</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.sleep || '--' }}<span class="unit" *ngIf="currentEntry?.sleep">%</span></div>
        <div class="stat-label">Sleep Score</div>
      </div>
    </div>

    <!-- Strain Card -->
    <div class="stat-card strain-card" [class.has-data]="currentEntry?.strain">
      <div class="stat-icon">üî•</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.strain || '--' }}</div>
        <div class="stat-label">Strain</div>
      </div>
    </div>

    <!-- RHR Card -->
    <div class="stat-card rhr-card" [class.has-data]="currentEntry?.rhr">
      <div class="stat-icon">‚ù§Ô∏è</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.rhr || '--' }}<span class="unit" *ngIf="currentEntry?.rhr">bpm</span></div>
        <div class="stat-label">Resting HR</div>
      </div>
    </div>

    <!-- Weight Card -->
    <div class="stat-card weight-card" [class.has-data]="currentEntry?.weight">
      <div class="stat-icon">‚öñÔ∏è</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.weight || '--' }}<span class="unit" *ngIf="currentEntry?.weight">lbs</span></div>
        <div class="stat-label">Weight</div>
      </div>
    </div>

    <!-- Daily Score Card -->
    <div class="stat-card score-card" [class.has-data]="currentEntry?.dailyScore != null">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <div class="stat-value">{{ currentEntry?.dailyScore ?? '--' }}</div>
        <div class="stat-label">Daily Score</div>
      </div>
    </div>
  </div>

  <div class="loading-dashboard" *ngIf="isLoadingDashboard">
    Loading...
  </div>

  <!-- Training Section -->
  <div class="training-section" *ngIf="!isLoadingDashboard">
    <div class="section-header">
      <h3>Training</h3>
      <button class="plan-workout-btn" (click)="openWorkoutPlanner()">
        {{ getPlannedWorkout() ? '‚úé Edit Plan' : '+ Plan Workout' }}
      </button>
    </div>

    <!-- Planned Workout Display -->
    <div class="planned-workout" *ngIf="getPlannedWorkout() as planned">
      <div class="planned-header">
        <div class="planned-title">
          <span class="planned-type">{{ planned.type }}</span>
          <span class="planned-duration">{{ planned.targetDuration }} min target</span>
        </div>
        <div class="planned-actions">
          <button 
            class="copy-btn-small" 
            *ngIf="planned.exercises && planned.exercises.length > 0"
            (click)="copyPlannedWorkoutToClipboard()"
            title="Copy for Calendar">
            üìã
          </button>
          <button 
            class="complete-btn" 
            [class.completed]="currentEntry?.workoutCompleted"
            (click)="toggleWorkoutCompleted()">
            {{ currentEntry?.workoutCompleted ? '‚úì Completed' : 'Mark Complete' }}
          </button>
        </div>
      </div>
      
      <div class="exercise-list">
        <div class="exercise-item" *ngFor="let ex of planned.exercises">
          <span class="exercise-name">{{ ex.name }}</span>
          <span class="exercise-details">
            {{ ex.sets }} √ó {{ ex.reps }}
            <span *ngIf="ex.weight"> &#64; {{ ex.weight }}</span>
          </span>
          <span class="exercise-notes" *ngIf="ex.notes">{{ ex.notes }}</span>
        </div>
      </div>
    </div>

    <!-- Whoop Actual Results (supplements planned workout) -->
    <div class="whoop-results" *ngIf="whoopWorkouts.length > 0">
      <h4 class="results-title">Whoop Activities</h4>
      <div class="workout-cards">
        <div class="workout-card clickable" 
             *ngFor="let w of whoopWorkouts"
             [class.has-exercises]="getWhoopWorkoutExercises(w).length > 0"
             (click)="openWhoopWorkoutEditor(w)">
          <div class="workout-header">
            <span class="workout-sport">{{ w.sport }}</span>
            <div class="workout-header-right">
              <span class="workout-time">{{ w.startTime }}</span>
              <button 
                class="copy-btn-small" 
                *ngIf="getWhoopWorkoutExercises(w).length > 0"
                (click)="copyWhoopWorkoutToClipboard(w, $event)"
                title="Copy for Calendar">
                üìã
              </button>
              <span class="edit-hint">‚úé Add details</span>
            </div>
          </div>
          <div class="workout-stats">
            <div class="workout-stat">
              <span class="workout-stat-value">{{ w.strain }}</span>
              <span class="workout-stat-label">Strain</span>
            </div>
            <div class="workout-stat">
              <span class="workout-stat-value">{{ w.duration }}m</span>
              <span class="workout-stat-label">Duration</span>
            </div>
            <div class="workout-stat">
              <span class="workout-stat-value">{{ w.calories }}</span>
              <span class="workout-stat-label">kcal</span>
            </div>
            <div class="workout-stat">
              <span class="workout-stat-value">{{ w.avgHR }}/{{ w.maxHR }}</span>
              <span class="workout-stat-label">Avg/Max HR</span>
            </div>
          </div>
          <!-- Show saved exercises for this workout -->
          <div class="workout-exercises" *ngIf="getWhoopWorkoutExercises(w).length > 0">
            <div class="workout-exercise" *ngFor="let ex of getWhoopWorkoutExercises(w)">
              <span class="ex-name">{{ ex.name }}</span>
              <span class="ex-details">{{ ex.sets }}√ó{{ ex.reps }}<span *ngIf="ex.weight"> &#64; {{ ex.weight }}</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No workout message -->
    <div class="no-workouts" *ngIf="!getPlannedWorkout() && whoopWorkouts.length === 0">
      No workout planned for this day
    </div>
  </div>
  
  <!-- Whoop Workout Editor Modal -->
  <div class="form-overlay" *ngIf="editingWhoopWorkout" (click)="closeWhoopWorkoutEditor()"></div>
  <div class="form-modal workout-planner-modal" *ngIf="editingWhoopWorkout">
    <div class="form-modal-header">
      <h3>{{ editingWhoopWorkout.sport }} - {{ editingWhoopWorkout.startTime }}</h3>
      <button class="close-btn" (click)="closeWhoopWorkoutEditor()">√ó</button>
    </div>
    
    <!-- Whoop Stats Summary -->
    <div class="whoop-stats-summary">
      <div class="summary-stat">
        <span class="summary-value">{{ editingWhoopWorkout.strain }}</span>
        <span class="summary-label">Strain</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value">{{ editingWhoopWorkout.duration }}m</span>
        <span class="summary-label">Duration</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value">{{ editingWhoopWorkout.calories }}</span>
        <span class="summary-label">Calories</span>
      </div>
      <div class="summary-stat">
        <span class="summary-value">{{ editingWhoopWorkout.avgHR }}/{{ editingWhoopWorkout.maxHR }}</span>
        <span class="summary-label">Avg/Max HR</span>
      </div>
    </div>
    
    <form [formGroup]="workoutForm" class="workout-planner-form">
      <div class="exercise-builder">
        <h4>Exercises Performed</h4>
        
        <!-- Add Exercise Form -->
        <div class="add-exercise-form">
          <input type="text" formControlName="exerciseName" placeholder="Exercise name (e.g., Bench Press)">
          <input type="number" formControlName="exerciseSets" placeholder="Sets" min="1" max="20" class="small-input">
          <input type="text" formControlName="exerciseReps" placeholder="Reps" class="small-input">
          <input type="text" formControlName="exerciseWeight" placeholder="Weight">
          <button type="button" class="add-exercise-btn" (click)="addExercise()">+ Add</button>
        </div>
        
        <!-- Exercise List -->
        <div class="planned-exercises" *ngIf="exercises.length > 0">
          <div class="planned-exercise" *ngFor="let ex of exercises; let i = index">
            <div class="exercise-info">
              <strong>{{ ex.name }}</strong>
              <span>{{ ex.sets }} √ó {{ ex.reps }}</span>
              <span *ngIf="ex.weight">&#64; {{ ex.weight }}</span>
            </div>
            <button type="button" class="remove-exercise-btn" (click)="removeExercise(i)">√ó</button>
          </div>
        </div>
        
        <div class="no-exercises" *ngIf="exercises.length === 0">
          No exercises added yet. Add what you did during this workout.
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeWhoopWorkoutEditor()">Cancel</button>
        <button type="button" class="copy-calendar-btn" (click)="copyExercisesToClipboard()" *ngIf="exercises.length > 0">üìã Copy for Calendar</button>
        <button type="button" class="submit-btn" (click)="saveWhoopWorkoutExercises()">Save Exercises</button>
      </div>
    </form>
  </div>
  
  <!-- Workout Planner Modal -->
  <div class="form-overlay" *ngIf="showWorkoutPlanner" (click)="closeWorkoutPlanner()"></div>
  <div class="form-modal workout-planner-modal" *ngIf="showWorkoutPlanner">
    <div class="form-modal-header">
      <h3>Plan Workout for {{ getFormattedDate() }}</h3>
      <button class="close-btn" (click)="closeWorkoutPlanner()">√ó</button>
    </div>
    
    <form [formGroup]="workoutForm" class="workout-planner-form">
      <div class="form-grid">
        <div class="form-group">
          <label>Workout Type</label>
          <select formControlName="type" class="workout-type-select">
            <option value="Strength Training">Strength Training</option>
            <option value="Weightlifting">Weightlifting</option>
            <option value="Cardio">Cardio</option>
            <option value="HIIT">HIIT</option>
            <option value="Yoga">Yoga</option>
            <option value="Running">Running</option>
            <option value="Cycling">Cycling</option>
            <option value="Swimming">Swimming</option>
            <option value="CrossFit">CrossFit</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Target Duration (min)</label>
          <input type="number" formControlName="targetDuration" min="5" max="300">
        </div>
      </div>
      
      <button type="button" 
              class="copy-last-btn" 
              [class.disabled]="!hasLastWorkout()"
              [disabled]="!hasLastWorkout()"
              (click)="copyLastWorkout()">
        üìã Copy Last Workout
        <span class="copy-hint" *ngIf="!hasLastWorkout()">(no previous found)</span>
      </button>
      
      <div class="exercise-builder">
        <h4>Exercises</h4>
        
        <!-- Add Exercise Form -->
        <div class="add-exercise-form">
          <input type="text" formControlName="exerciseName" placeholder="Exercise name (e.g., Bench Press)">
          <input type="number" formControlName="exerciseSets" placeholder="Sets" min="1" max="20" class="small-input">
          <input type="text" formControlName="exerciseReps" placeholder="Reps" class="small-input">
          <input type="text" formControlName="exerciseWeight" placeholder="Weight (optional)">
          <button type="button" class="add-exercise-btn" (click)="addExercise()">+ Add</button>
        </div>
        
        <!-- Exercise List -->
        <div class="planned-exercises" *ngIf="exercises.length > 0">
          <div class="planned-exercise" *ngFor="let ex of exercises; let i = index">
            <div class="exercise-info">
              <strong>{{ ex.name }}</strong>
              <span>{{ ex.sets }} √ó {{ ex.reps }}</span>
              <span *ngIf="ex.weight">&#64; {{ ex.weight }}</span>
            </div>
            <button type="button" class="remove-exercise-btn" (click)="removeExercise(i)">√ó</button>
          </div>
        </div>
        
        <div class="no-exercises" *ngIf="exercises.length === 0">
          No exercises added yet
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeWorkoutPlanner()">Cancel</button>
        <button type="button" class="copy-calendar-btn" (click)="copyExercisesToClipboard()" *ngIf="exercises.length > 0">üìã Copy for Calendar</button>
        <button type="button" class="submit-btn" (click)="saveWorkoutPlan()">Save Workout Plan</button>
      </div>
    </form>
  </div>

  <!-- Actions -->
  <div class="dashboard-actions">
    <button *ngIf="!currentEntry" (click)="addEntryForDate()" class="action-btn primary">
      + Add Entry for {{ getFormattedDate() }}
    </button>
    <button *ngIf="currentEntry" (click)="editEntry(currentEntry)" class="action-btn secondary">
      ‚úé Edit Entry
    </button>
    <button *ngIf="whoopConnected && !currentEntry" (click)="importFromWhoop()" class="action-btn whoop" [disabled]="whoopLoading">
      {{ whoopLoading ? 'Importing...' : 'Import from Whoop' }}
    </button>
    <!-- Token expired - show reconnect -->
    <button *ngIf="whoopExpired && !whoopConnected" (click)="reconnectWhoop()" class="action-btn whoop">
      üîÑ Reconnect Whoop
    </button>
    <!-- Not connected at all -->
    <a *ngIf="!whoopConnected && !whoopExpired" routerLink="/integrations" class="action-btn connect">
      Connect Whoop
    </a>
  </div>
  
  <!-- Whoop Status Message -->
  <div class="whoop-status success" *ngIf="whoopConnected && whoopHasRefreshToken">
    <span class="status-icon">‚úì</span>
    <span class="status-text">Whoop connected (auto-renewing)</span>
  </div>
  <div class="whoop-status" *ngIf="whoopConnected && !whoopHasRefreshToken && whoopExpiryMinutes !== null">
    <span class="status-icon">‚è±Ô∏è</span>
    <span class="status-text">Whoop token expires in {{ whoopExpiryMinutes }} min (no auto-renew)</span>
  </div>
  <div class="whoop-status expired" *ngIf="whoopExpired && !whoopConnected">
    <span class="status-icon">‚ö†Ô∏è</span>
    <span class="status-text">Whoop session expired - click Reconnect to continue importing data</span>
  </div>

  <!-- Entry Form Modal -->
  <div class="form-overlay" *ngIf="showForm" (click)="toggleForm()"></div>
  <div class="form-modal" *ngIf="showForm">
    <div class="form-modal-header">
      <h3>{{ editingId ? 'Edit Entry' : 'New Entry' }}</h3>
      <button class="close-btn" (click)="toggleForm()">√ó</button>
    </div>
    
    <form [formGroup]="healthForm" (ngSubmit)="onSubmit()" class="health-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="date">Date</label>
          <input type="date" id="date" formControlName="date" required>
        </div>
        <div class="form-group">
          <label for="recovery">Recovery %</label>
          <input type="number" id="recovery" formControlName="recovery" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="sleep">Sleep %</label>
          <input type="number" id="sleep" formControlName="sleep" placeholder="0-100">
        </div>
        <div class="form-group">
          <label for="strain">Strain</label>
          <input type="number" id="strain" formControlName="strain" placeholder="0-21" step="0.1">
        </div>
        <div class="form-group">
          <label for="rhr">RHR (bpm)</label>
          <input type="number" id="rhr" formControlName="rhr" placeholder="bpm">
        </div>
        <div class="form-group">
          <label for="weight">Weight (lbs)</label>
          <input type="number" id="weight" formControlName="weight" placeholder="lbs" step="0.1">
        </div>
        <div class="form-group">
          <label for="bp">Blood Pressure</label>
          <input type="text" id="bp" formControlName="bp" placeholder="120/80">
        </div>
        <div class="form-group">
          <label for="dailyScore">Daily Score</label>
          <input type="number" id="dailyScore" formControlName="dailyScore" placeholder="-2 to 2" step="0.1">
        </div>
      </div>

      <!-- Whoop Import in Form -->
      <div class="whoop-import-section" *ngIf="whoopConnected">
        <button type="button" (click)="fetchFromWhoop()" class="whoop-import-btn" [disabled]="whoopLoading">
          {{ whoopLoading ? 'Fetching...' : '‚Üì Import from Whoop' }}
        </button>
        <span class="whoop-msg" *ngIf="whoopMessage">{{ whoopMessage }}</span>
      </div>

      <div class="form-actions">
        <button type="button" (click)="toggleForm()" class="cancel-btn">Cancel</button>
        <button type="submit" [disabled]="!healthForm.valid || isLoading" class="submit-btn">
          {{ isLoading ? 'Saving...' : (editingId ? 'Update' : 'Save') }}
        </button>
      </div>
      
      <div class="save-message" *ngIf="saveMessage" [class.error]="saveMessage.includes('Error')">
        {{ saveMessage }}
      </div>
    </form>
  </div>

  <!-- History Section -->
  <div class="history-section">
    <h3>History</h3>
    <div *ngIf="isLoadingEntries" class="loading">Loading...</div>
    
    <div class="history-list" *ngIf="!isLoadingEntries && entries.length > 0">
      <div class="history-item" *ngFor="let entry of entries" 
           [class.selected]="entry.date === selectedDate"
           (click)="selectedDate = entry.date; loadDashboard()">
        <span class="history-date">{{ entry.date }}</span>
        <div class="history-stats">
          <span *ngIf="entry.recovery" class="mini-stat recovery">{{ entry.recovery }}%</span>
          <span *ngIf="entry.strain" class="mini-stat strain">{{ entry.strain }}</span>
          <span *ngIf="$any(entry).workoutCount" class="mini-stat workout">{{ $any(entry).workoutCount }}üèãÔ∏è</span>
        </div>
      </div>
    </div>

    <div *ngIf="!isLoadingEntries && entries.length === 0" class="no-entries">
      No entries yet
    </div>
  </div>
</div>
